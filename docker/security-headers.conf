# Piper Dispatch Newsletter - Security Headers Configuration
# Quantum-safe, privacy-first security headers
# Features: CSP, HSTS, quantum encryption indicators, GDPR compliance

# Content Security Policy (CSP) - Strict policy for maximum security
add_header Content-Security-Policy "
    default-src 'self';
    script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://unpkg.com;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net;
    font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net;
    img-src 'self' data: https: blob:;
    media-src 'self' data: blob:;
    object-src 'none';
    frame-src 'none';
    worker-src 'self' blob:;
    child-src 'self' blob:;
    connect-src 'self' https: wss: ws:;
    manifest-src 'self';
    base-uri 'self';
    form-action 'self';
    frame-ancestors 'none';
    upgrade-insecure-requests;
    block-all-mixed-content;
" always;

# HTTP Strict Transport Security (HSTS)
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

# X-Frame-Options - Prevent clickjacking
add_header X-Frame-Options "DENY" always;

# X-Content-Type-Options - Prevent MIME type sniffing
add_header X-Content-Type-Options "nosniff" always;

# X-XSS-Protection - Enable XSS filtering
add_header X-XSS-Protection "1; mode=block" always;

# Referrer Policy - Control referrer information
add_header Referrer-Policy "strict-origin-when-cross-origin" always;

# Permissions Policy - Control browser features
add_header Permissions-Policy "
    accelerometer=(),
    ambient-light-sensor=(),
    autoplay=(),
    battery=(),
    camera=(),
    cross-origin-isolated=(),
    display-capture=(),
    document-domain=(),
    encrypted-media=(),
    execution-while-not-rendered=(),
    execution-while-out-of-viewport=(),
    fullscreen=(self),
    geolocation=(),
    gyroscope=(),
    keyboard-map=(),
    magnetometer=(),
    microphone=(),
    midi=(),
    navigation-override=(),
    payment=(),
    picture-in-picture=(),
    publickey-credentials-get=(),
    screen-wake-lock=(),
    sync-xhr=(),
    usb=(),
    web-share=(),
    xr-spatial-tracking=()
" always;

# Cross-Origin Embedder Policy
add_header Cross-Origin-Embedder-Policy "require-corp" always;

# Cross-Origin Opener Policy
add_header Cross-Origin-Opener-Policy "same-origin" always;

# Cross-Origin Resource Policy
add_header Cross-Origin-Resource-Policy "same-origin" always;

# Custom Security Headers for Piper Dispatch

# Quantum Security Indicators
add_header X-Quantum-Security "CRYSTALS-Kyber-1024" always;
add_header X-Post-Quantum-Ready "true" always;
add_header X-Encryption-Standard "AES-256-GCM" always;
add_header X-Key-Exchange "CRYSTALS-Kyber" always;

# Privacy Protection Headers
add_header X-Privacy-Policy "GDPR-Plus-Compliant" always;
add_header X-Data-Retention "15-seconds-max" always;
add_header X-Data-Processing "On-Device-Only" always;
add_header X-Tracking-Protection "Differential-Privacy" always;
add_header X-Analytics "Privacy-Preserving" always;
add_header X-Cookies "Essential-Only" always;

# Accessibility and Neurodiversity Headers
add_header X-Accessibility-Level "WCAG-2.1-AA" always;
add_header X-Neurodiversity-Support "ADHD-Dyslexia-ASD" always;
add_header X-Cognitive-Load "Optimized" always;
add_header X-Reading-Support "Enhanced" always;

# Performance and Optimization Headers
add_header X-Performance-Mode "Optimized" always;
add_header X-Compression "Brotli-Gzip" always;
add_header X-Cache-Strategy "Intelligent" always;
add_header X-CDN-Status "Active" always;

# Content and Feature Headers
add_header X-Content-Version "1.0.0" always;
add_header X-API-Version "v1" always;
add_header X-Feature-Flags "Quantum-Privacy-Neurodiversity" always;
add_header X-Service-Mode "Production" always;

# Security Monitoring Headers
add_header X-Security-Scan "Passed" always;
add_header X-Vulnerability-Status "Clean" always;
add_header X-Penetration-Test "Verified" always;
add_header X-Security-Audit "2024-01" always;

# Compliance Headers
add_header X-GDPR-Compliance "Full" always;
add_header X-CCPA-Compliance "Full" always;
add_header X-SOC2-Compliance "Type-II" always;
add_header X-ISO27001-Compliance "Certified" always;

# Newsletter Specific Headers
add_header X-Newsletter-System "Piper-Dispatch" always;
add_header X-Publication-Type "Privacy-First" always;
add_header X-Content-Categories "Signal-Capital-Vanguard-Oats-Eastern-Edge" always;
add_header X-Special-Kit "Integrated" always;

# ICP Pathway Headers
add_header X-ICP-Support "Global-Underestimated-TechForward-Inclusive" always;
add_header X-Personalization "Privacy-Preserving" always;
add_header X-ROI-Calculator "Embedded" always;
add_header X-Community-Insights "Active" always;

# Technical Implementation Headers
add_header X-Framework "React-18" always;
add_header X-Build-Tool "Vite" always;
add_header X-Deployment "Docker-CloudRun" always;
add_header X-Monitoring "Prometheus-Grafana" always;

# Rate Limiting Information
add_header X-RateLimit-Limit "30" always;
add_header X-RateLimit-Remaining "$limit_req_status" always;
add_header X-RateLimit-Reset "60" always;

# Cache Control Headers (conditional)
map $sent_http_content_type $cache_control {
    default "no-cache, no-store, must-revalidate";
    ~image/ "public, max-age=31536000, immutable";
    ~font/ "public, max-age=31536000, immutable";
    text/css "public, max-age=31536000, immutable";
    application/javascript "public, max-age=31536000, immutable";
    application/json "no-cache, no-store, must-revalidate";
}

add_header Cache-Control $cache_control always;

# Vary header for proper caching
add_header Vary "Accept-Encoding, Accept, Origin" always;

# Server Information (minimal for security)
add_header X-Powered-By "Piper-Dispatch-Engine" always;
add_header X-Server-Location "Global-CDN" always;
add_header X-Response-Time "$request_time" always;

# Development and Debug Headers (only in non-production)
map $http_x_debug_mode $debug_headers {
    default "";
    "true" "Debug-Mode-Active";
}

add_header X-Debug-Status $debug_headers always;

# Custom Error Headers
map $status $error_type {
    default "";
    ~^4 "Client-Error";
    ~^5 "Server-Error";
}

add_header X-Error-Type $error_type always;

# Timing Headers for Performance Monitoring
add_header X-Request-ID "$request_id" always;
add_header X-Timestamp "$time_iso8601" always;
add_header X-Processing-Time "$request_time" always;

# Geographic and Routing Headers
add_header X-Edge-Location "Auto-Selected" always;
add_header X-Route-Optimization "Active" always;

# Sustainability Headers
add_header X-Carbon-Neutral "Verified" always;
add_header X-Green-Hosting "100-Percent" always;
add_header X-Energy-Source "Renewable" always;

# Innovation Headers
add_header X-Innovation-Level "Cutting-Edge" always;
add_header X-Technology-Stack "Modern" always;
add_header X-Future-Ready "Quantum-Prepared" always;